function shuffle(e){for(var t,n,r=e.length;r;t=Math.floor(Math.random()*r),n=e[--r],e[r]=e[t],e[t]=n);return e}var events={};window.fbAsyncInit=function(){FB.init({appId:"164810690371362",channelUrl:"http://www.seas.upenn.edu/~noamz/musiqueue/",status:true,cookie:true,xfbml:true});FB.Event.subscribe("auth.authResponseChange",function(e){if(e.status==="connected"){var t=FB.getAuthResponse().accessToken;$.ajax({url:"https://graph.facebook.com/me/events?access_token="+t}).done(function(e){function i(e){$("#content").addClass("blur");var n=$(e.target).html();var r="https://graph.facebook.com/fql/?q=SELECT music FROM user WHERE uid IN (SELECT uid FROM event_member WHERE eid="+$(e.target).attr("id")+' AND rsvp_status="attending") AND uid IN (SELECT uid2 FROM friend WHERE uid1 = me())&access_token='+t;$.ajax({url:r}).done(function(e){var t=e.data;var r={};for(var i=0;i<t.length;i++){var s=t[i].music.split(", ");for(var o=0;o<s.length;o++){if(s[o]!=""){if(r[s[o]]){r[s[o]]++}else{r[s[o]]=1}}}}var u={};var a=0;for(var f in r){if(r[f]>a){a=r[f]}if(u[r[f]]){u[r[f]].push(f)}else{u[r[f]]=[f]}}var s=[];for(var i=a;i>0;i--){s=s.concat(u[i]||[])}var l="http://ws.spotify.com/search/1/track.json?q=artist:";num_artists=s.length>10?10:s.length;var c=[];for(var i=0;i<num_artists;i++){$.ajax({url:l+s[i].toLowerCase().replace(/ /g,"+")}).done(function(e){c.push(e);if(c.length==num_artists){var t=[];for(var r=0;r<num_artists;r++){var i=[];var s=c[r].tracks.length>5?5:c[r].tracks.length;for(var o=0;o<s;o++){i.push(c[r]["tracks"][o].href.replace(/^.*:(\w+)$/g,"$1"))}t=t.concat(i)}t=shuffle(t);$("#response").html("<iframe src='https://embed.spotify.com/?uri=spotify:trackset:"+n+":"+t.join(",")+"' width='300' height='380' frameborder='0' allowtransparency='true'></iframe>");$("#response").show();setTimeout(function(){$("#response").addClass("vis")},500);$("body").click(function(){$("#response").removeClass("vis");$("#content").removeClass("blur");setTimeout(function(){$("#response").hide()},500);$("body").unbind("click")})}})}})}events=e.data;var n="";for(var r=0;r<events.length;r++){n+="<li><a id="+events[r].id+' class="event">'+events[r].name+"</a></li>"}$("#events").html(n);$(".event").click(i);})}else if(e.status==="not_authorized"){FB.login()}else{FB.login()}})};(function(e){var t,n="facebook-jssdk",r=e.getElementsByTagName("script")[0];if(e.getElementById(n)){return}t=e.createElement("script");t.id=n;t.async=true;t.src="//connect.facebook.net/en_US/all.js";r.parentNode.insertBefore(t,r)})(document);